<?php

namespace App\Http\Controllers;
use Illuminate\Support\Facades\Auth;
use App\Event;
use App\Element;
use Illuminate\Support\Facades\DB;
use Illuminate\Http\Request;
use Carbon\Carbon;

class UserController extends Controller
{
    public function myEventsManagement()
    {
        $user = Auth::user();
        if($user){
            $table = 'elements';
            $columns = DB::select("SHOW COLUMNS FROM ". $table." WHERE Field = 'type'");
            preg_match("/^enum\(\'(.*)\'\)$/", $columns[0]->Type, $matches);
            $enum = explode("','", $matches[1]); //in $enum are all input types for an element
    
             $myEvents = Event::where('user_id',$user->id)->get();  //only this user's events will show up

            //  https://guzzle.readthedocs.io/en/latest/quickstart.html#using-responses
            //  $client = new \GuzzleHttp\Client();
            //  $data = $client->request('GET', 'https://api.openweathermap.org/data/2.5/forecast?id=2593105&appid=c0d3d6d2e29c32877223d60ce0071fa6&units=metric');
            // $body = $data->getBody();
            // $data = json_decode($body);
           
            $body = '{"cod":"200","message":0.0033,"cnt":40,"list":[{"dt":1545760800,"main":{"temp":292.39,"temp_min":292.39,"temp_max":292.822,"pressure":1031.41,"sea_level":1034.68,"grnd_level":1031.41,"humidity":98,"temp_kf":-0.43},"weather":[{"id":802,"main":"Clouds","description":"scattered clouds","icon":"03d"}],"clouds":{"all":32},"wind":{"speed":5.01,"deg":211.514},"rain":{},"sys":{"pod":"d"},"dt_txt":"2018-12-25 18:00:00"},{"dt":1545771600,"main":{"temp":292.4,"temp_min":292.4,"temp_max":292.725,"pressure":1032.94,"sea_level":1036.27,"grnd_level":1032.94,"humidity":98,"temp_kf":-0.32},"weather":[{"id":802,"main":"Clouds","description":"scattered clouds","icon":"03n"}],"clouds":{"all":48},"wind":{"speed":3.96,"deg":214.5},"rain":{},"sys":{"pod":"n"},"dt_txt":"2018-12-25 21:00:00"},{"dt":1545782400,"main":{"temp":292.42,"temp_min":292.42,"temp_max":292.631,"pressure":1033.87,"sea_level":1037.14,"grnd_level":1033.87,"humidity":98,"temp_kf":-0.22},"weather":[{"id":802,"main":"Clouds","description":"scattered clouds","icon":"03n"}],"clouds":{"all":48},"wind":{"speed":2.56,"deg":211.002},"rain":{},"sys":{"pod":"n"},"dt_txt":"2018-12-26 00:00:00"},{"dt":1545793200,"main":{"temp":292.34,"temp_min":292.34,"temp_max":292.446,"pressure":1034.01,"sea_level":1037.37,"grnd_level":1034.01,"humidity":100,"temp_kf":-0.11},"weather":[{"id":804,"main":"Clouds","description":"overcast clouds","icon":"04n"}],"clouds":{"all":88},"wind":{"speed":1.26,"deg":188.502},"rain":{},"sys":{"pod":"n"},"dt_txt":"2018-12-26 03:00:00"},{"dt":1545804000,"main":{"temp":292.308,"temp_min":292.308,"temp_max":292.308,"pressure":1034.14,"sea_level":1037.48,"grnd_level":1034.14,"humidity":100,"temp_kf":0},"weather":[{"id":803,"main":"Clouds","description":"broken clouds","icon":"04n"}],"clouds":{"all":56},"wind":{"speed":1.11,"deg":116.501},"rain":{},"sys":{"pod":"n"},"dt_txt":"2018-12-26 06:00:00"},{"dt":1545814800,"main":{"temp":292.262,"temp_min":292.262,"temp_max":292.262,"pressure":1035.62,"sea_level":1038.91,"grnd_level":1035.62,"humidity":100,"temp_kf":0},"weather":[{"id":803,"main":"Clouds","description":"broken clouds","icon":"04d"}],"clouds":{"all":56},"wind":{"speed":1.6,"deg":76.5014},"rain":{},"sys":{"pod":"d"},"dt_txt":"2018-12-26 09:00:00"},{"dt":1545825600,"main":{"temp":292.594,"temp_min":292.594,"temp_max":292.594,"pressure":1036.26,"sea_level":1039.59,"grnd_level":1036.26,"humidity":99,"temp_kf":0},"weather":[{"id":802,"main":"Clouds","description":"scattered clouds","icon":"03d"}],"clouds":{"all":44},"wind":{"speed":2.68,"deg":73.5036},"rain":{},"sys":{"pod":"d"},"dt_txt":"2018-12-26 12:00:00"},{"dt":1545836400,"main":{"temp":292.611,"temp_min":292.611,"temp_max":292.611,"pressure":1035.09,"sea_level":1038.31,"grnd_level":1035.09,"humidity":100,"temp_kf":0},"weather":[{"id":800,"main":"Clear","description":"clear sky","icon":"02d"}],"clouds":{"all":8},"wind":{"speed":3.43,"deg":83.0045},"rain":{},"sys":{"pod":"d"},"dt_txt":"2018-12-26 15:00:00"},{"dt":1545847200,"main":{"temp":292.442,"temp_min":292.442,"temp_max":292.442,"pressure":1035.66,"sea_level":1038.98,"grnd_level":1035.66,"humidity":100,"temp_kf":0},"weather":[{"id":800,"main":"Clear","description":"clear sky","icon":"01d"}],"clouds":{"all":0},"wind":{"speed":4.01,"deg":74.5055},"rain":{},"sys":{"pod":"d"},"dt_txt":"2018-12-26 18:00:00"},{"dt":1545858000,"main":{"temp":292.1,"temp_min":292.1,"temp_max":292.1,"pressure":1036.65,"sea_level":1039.92,"grnd_level":1036.65,"humidity":100,"temp_kf":0},"weather":[{"id":800,"main":"Clear","description":"clear sky","icon":"01n"}],"clouds":{"all":0},"wind":{"speed":4.61,"deg":59.5005},"rain":{},"sys":{"pod":"n"},"dt_txt":"2018-12-26 21:00:00"},{"dt":1545868800,"main":{"temp":291.937,"temp_min":291.937,"temp_max":291.937,"pressure":1036.96,"sea_level":1040.32,"grnd_level":1036.96,"humidity":100,"temp_kf":0},"weather":[{"id":800,"main":"Clear","description":"clear sky","icon":"01n"}],"clouds":{"all":0},"wind":{"speed":4.91,"deg":53.5048},"rain":{},"sys":{"pod":"n"},"dt_txt":"2018-12-27 00:00:00"},{"dt":1545879600,"main":{"temp":291.849,"temp_min":291.849,"temp_max":291.849,"pressure":1036.8,"sea_level":1040.06,"grnd_level":1036.8,"humidity":100,"temp_kf":0},"weather":[{"id":800,"main":"Clear","description":"clear sky","icon":"01n"}],"clouds":{"all":0},"wind":{"speed":5.41,"deg":61},"rain":{},"sys":{"pod":"n"},"dt_txt":"2018-12-27 03:00:00"},{"dt":1545890400,"main":{"temp":291.704,"temp_min":291.704,"temp_max":291.704,"pressure":1036.95,"sea_level":1040.17,"grnd_level":1036.95,"humidity":100,"temp_kf":0},"weather":[{"id":800,"main":"Clear","description":"clear sky","icon":"02n"}],"clouds":{"all":8},"wind":{"speed":5.62,"deg":67.5067},"rain":{},"sys":{"pod":"n"},"dt_txt":"2018-12-27 06:00:00"},{"dt":1545901200,"main":{"temp":291.784,"temp_min":291.784,"temp_max":291.784,"pressure":1037.98,"sea_level":1041.3,"grnd_level":1037.98,"humidity":100,"temp_kf":0},"weather":[{"id":801,"main":"Clouds","description":"few clouds","icon":"02d"}],"clouds":{"all":20},"wind":{"speed":5.72,"deg":62.5002},"rain":{},"sys":{"pod":"d"},"dt_txt":"2018-12-27 09:00:00"},{"dt":1545912000,"main":{"temp":291.879,"temp_min":291.879,"temp_max":291.879,"pressure":1038.38,"sea_level":1041.78,"grnd_level":1038.38,"humidity":100,"temp_kf":0},"weather":[{"id":803,"main":"Clouds","description":"broken clouds","icon":"04d"}],"clouds":{"all":56},"wind":{"speed":6.01,"deg":59.5},"rain":{},"sys":{"pod":"d"},"dt_txt":"2018-12-27 12:00:00"},{"dt":1545922800,"main":{"temp":291.878,"temp_min":291.878,"temp_max":291.878,"pressure":1036.98,"sea_level":1040.24,"grnd_level":1036.98,"humidity":100,"temp_kf":0},"weather":[{"id":500,"main":"Rain","description":"light rain","icon":"10d"}],"clouds":{"all":12},"wind":{"speed":6.21,"deg":64.5003},"rain":{"3h":0.0099999999999998},"sys":{"pod":"d"},"dt_txt":"2018-12-27 15:00:00"},{"dt":1545933600,"main":{"temp":291.823,"temp_min":291.823,"temp_max":291.823,"pressure":1037.2,"sea_level":1040.54,"grnd_level":1037.2,"humidity":100,"temp_kf":0},"weather":[{"id":800,"main":"Clear","description":"clear sky","icon":"01d"}],"clouds":{"all":0},"wind":{"speed":6.36,"deg":60.5034},"rain":{},"sys":{"pod":"d"},"dt_txt":"2018-12-27 18:00:00"},{"dt":1545944400,"main":{"temp":291.515,"temp_min":291.515,"temp_max":291.515,"pressure":1037.94,"sea_level":1041.31,"grnd_level":1037.94,"humidity":100,"temp_kf":0},"weather":[{"id":803,"main":"Clouds","description":"broken clouds","icon":"04n"}],"clouds":{"all":76},"wind":{"speed":6.61,"deg":59.0043},"rain":{},"sys":{"pod":"n"},"dt_txt":"2018-12-27 21:00:00"},{"dt":1545955200,"main":{"temp":291.278,"temp_min":291.278,"temp_max":291.278,"pressure":1038.05,"sea_level":1041.32,"grnd_level":1038.05,"humidity":100,"temp_kf":0},"weather":[{"id":500,"main":"Rain","description":"light rain","icon":"10n"}],"clouds":{"all":48},"wind":{"speed":6.56,"deg":57.0002},"rain":{"3h":0.01},"sys":{"pod":"n"},"dt_txt":"2018-12-28 00:00:00"},{"dt":1545966000,"main":{"temp":291.117,"temp_min":291.117,"temp_max":291.117,"pressure":1037.4,"sea_level":1040.69,"grnd_level":1037.4,"humidity":100,"temp_kf":0},"weather":[{"id":500,"main":"Rain","description":"light rain","icon":"10n"}],"clouds":{"all":20},"wind":{"speed":6.76,"deg":56.5001},"rain":{"3h":0.0099999999999998},"sys":{"pod":"n"},"dt_txt":"2018-12-28 03:00:00"},{"dt":1545976800,"main":{"temp":291.174,"temp_min":291.174,"temp_max":291.174,"pressure":1036.77,"sea_level":1040.15,"grnd_level":1036.77,"humidity":100,"temp_kf":0},"weather":[{"id":800,"main":"Clear","description":"clear sky","icon":"01n"}],"clouds":{"all":0},"wind":{"speed":6.72,"deg":68.5011},"rain":{},"sys":{"pod":"n"},"dt_txt":"2018-12-28 06:00:00"},{"dt":1545987600,"main":{"temp":290.999,"temp_min":290.999,"temp_max":290.999,"pressure":1037.8,"sea_level":1041.18,"grnd_level":1037.8,"humidity":100,"temp_kf":0},"weather":[{"id":804,"main":"Clouds","description":"overcast clouds","icon":"04d"}],"clouds":{"all":92},"wind":{"speed":7.82,"deg":75.5013},"rain":{},"sys":{"pod":"d"},"dt_txt":"2018-12-28 09:00:00"},{"dt":1545998400,"main":{"temp":291.148,"temp_min":291.148,"temp_max":291.148,"pressure":1038.21,"sea_level":1041.44,"grnd_level":1038.21,"humidity":100,"temp_kf":0},"weather":[{"id":500,"main":"Rain","description":"light rain","icon":"10d"}],"clouds":{"all":32},"wind":{"speed":7.66,"deg":76.0057},"rain":{"3h":0.03},"sys":{"pod":"d"},"dt_txt":"2018-12-28 12:00:00"},{"dt":1546009200,"main":{"temp":291.426,"temp_min":291.426,"temp_max":291.426,"pressure":1036.44,"sea_level":1039.66,"grnd_level":1036.44,"humidity":100,"temp_kf":0},"weather":[{"id":800,"main":"Clear","description":"clear sky","icon":"01d"}],"clouds":{"all":0},"wind":{"speed":7.26,"deg":75.5019},"rain":{},"sys":{"pod":"d"},"dt_txt":"2018-12-28 15:00:00"},{"dt":1546020000,"main":{"temp":291.405,"temp_min":291.405,"temp_max":291.405,"pressure":1036.49,"sea_level":1039.77,"grnd_level":1036.49,"humidity":100,"temp_kf":0},"weather":[{"id":801,"main":"Clouds","description":"few clouds","icon":"02d"}],"clouds":{"all":20},"wind":{"speed":7.17,"deg":74.0002},"rain":{},"sys":{"pod":"d"},"dt_txt":"2018-12-28 18:00:00"},{"dt":1546030800,"main":{"temp":291.304,"temp_min":291.304,"temp_max":291.304,"pressure":1037.2,"sea_level":1040.49,"grnd_level":1037.2,"humidity":100,"temp_kf":0},"weather":[{"id":800,"main":"Clear","description":"clear sky","icon":"01n"}],"clouds":{"all":0},"wind":{"speed":7.47,"deg":74.5012},"rain":{},"sys":{"pod":"n"},"dt_txt":"2018-12-28 21:00:00"},{"dt":1546041600,"main":{"temp":291.204,"temp_min":291.204,"temp_max":291.204,"pressure":1037.03,"sea_level":1040.28,"grnd_level":1037.03,"humidity":100,"temp_kf":0},"weather":[{"id":800,"main":"Clear","description":"clear sky","icon":"01n"}],"clouds":{"all":0},"wind":{"speed":7.52,"deg":72.5023},"rain":{},"sys":{"pod":"n"},"dt_txt":"2018-12-29 00:00:00"},{"dt":1546052400,"main":{"temp":290.931,"temp_min":290.931,"temp_max":290.931,"pressure":1036.23,"sea_level":1039.53,"grnd_level":1036.23,"humidity":100,"temp_kf":0},"weather":[{"id":800,"main":"Clear","description":"clear sky","icon":"02n"}],"clouds":{"all":8},"wind":{"speed":7.27,"deg":73.0046},"rain":{},"sys":{"pod":"n"},"dt_txt":"2018-12-29 03:00:00"},{"dt":1546063200,"main":{"temp":290.748,"temp_min":290.748,"temp_max":290.748,"pressure":1035.39,"sea_level":1038.61,"grnd_level":1035.39,"humidity":100,"temp_kf":0},"weather":[{"id":801,"main":"Clouds","description":"few clouds","icon":"02n"}],"clouds":{"all":20},"wind":{"speed":7.46,"deg":73.0024},"rain":{},"sys":{"pod":"n"},"dt_txt":"2018-12-29 06:00:00"},{"dt":1546074000,"main":{"temp":290.529,"temp_min":290.529,"temp_max":290.529,"pressure":1036.19,"sea_level":1039.5,"grnd_level":1036.19,"humidity":100,"temp_kf":0},"weather":[{"id":802,"main":"Clouds","description":"scattered clouds","icon":"03d"}],"clouds":{"all":32},"wind":{"speed":7.77,"deg":77.5019},"rain":{},"sys":{"pod":"d"},"dt_txt":"2018-12-29 09:00:00"},{"dt":1546084800,"main":{"temp":290.739,"temp_min":290.739,"temp_max":290.739,"pressure":1036.39,"sea_level":1039.68,"grnd_level":1036.39,"humidity":100,"temp_kf":0},"weather":[{"id":801,"main":"Clouds","description":"few clouds","icon":"02d"}],"clouds":{"all":12},"wind":{"speed":7.16,"deg":78.0026},"rain":{},"sys":{"pod":"d"},"dt_txt":"2018-12-29 12:00:00"},{"dt":1546095600,"main":{"temp":290.935,"temp_min":290.935,"temp_max":290.935,"pressure":1034.64,"sea_level":1037.93,"grnd_level":1034.64,"humidity":100,"temp_kf":0},"weather":[{"id":800,"main":"Clear","description":"clear sky","icon":"02d"}],"clouds":{"all":8},"wind":{"speed":6.53,"deg":75.5024},"rain":{},"sys":{"pod":"d"},"dt_txt":"2018-12-29 15:00:00"},{"dt":1546106400,"main":{"temp":291.029,"temp_min":291.029,"temp_max":291.029,"pressure":1034.97,"sea_level":1038.24,"grnd_level":1034.97,"humidity":100,"temp_kf":0},"weather":[{"id":800,"main":"Clear","description":"clear sky","icon":"01d"}],"clouds":{"all":0},"wind":{"speed":6.02,"deg":70.5054},"rain":{},"sys":{"pod":"d"},"dt_txt":"2018-12-29 18:00:00"},{"dt":1546117200,"main":{"temp":290.91,"temp_min":290.91,"temp_max":290.91,"pressure":1035.6,"sea_level":1038.94,"grnd_level":1035.6,"humidity":100,"temp_kf":0},"weather":[{"id":800,"main":"Clear","description":"clear sky","icon":"01n"}],"clouds":{"all":0},"wind":{"speed":6.3,"deg":71.5005},"rain":{},"sys":{"pod":"n"},"dt_txt":"2018-12-29 21:00:00"},{"dt":1546128000,"main":{"temp":290.966,"temp_min":290.966,"temp_max":290.966,"pressure":1035.37,"sea_level":1038.59,"grnd_level":1035.37,"humidity":100,"temp_kf":0},"weather":[{"id":800,"main":"Clear","description":"clear sky","icon":"01n"}],"clouds":{"all":0},"wind":{"speed":6.37,"deg":73.5014},"rain":{},"sys":{"pod":"n"},"dt_txt":"2018-12-30 00:00:00"},{"dt":1546138800,"main":{"temp":290.908,"temp_min":290.908,"temp_max":290.908,"pressure":1034.56,"sea_level":1037.84,"grnd_level":1034.56,"humidity":100,"temp_kf":0},"weather":[{"id":800,"main":"Clear","description":"clear sky","icon":"01n"}],"clouds":{"all":0},"wind":{"speed":6.56,"deg":72.5016},"rain":{},"sys":{"pod":"n"},"dt_txt":"2018-12-30 03:00:00"},{"dt":1546149600,"main":{"temp":290.794,"temp_min":290.794,"temp_max":290.794,"pressure":1033.74,"sea_level":1037.08,"grnd_level":1033.74,"humidity":100,"temp_kf":0},"weather":[{"id":800,"main":"Clear","description":"clear sky","icon":"02n"}],"clouds":{"all":8},"wind":{"speed":7.17,"deg":74.011},"rain":{},"sys":{"pod":"n"},"dt_txt":"2018-12-30 06:00:00"},{"dt":1546160400,"main":{"temp":291.041,"temp_min":291.041,"temp_max":291.041,"pressure":1034.52,"sea_level":1037.82,"grnd_level":1034.52,"humidity":100,"temp_kf":0},"weather":[{"id":800,"main":"Clear","description":"clear sky","icon":"01d"}],"clouds":{"all":0},"wind":{"speed":7.76,"deg":79.5006},"rain":{},"sys":{"pod":"d"},"dt_txt":"2018-12-30 09:00:00"},{"dt":1546171200,"main":{"temp":291.325,"temp_min":291.325,"temp_max":291.325,"pressure":1034.57,"sea_level":1037.9,"grnd_level":1034.57,"humidity":100,"temp_kf":0},"weather":[{"id":800,"main":"Clear","description":"clear sky","icon":"01d"}],"clouds":{"all":0},"wind":{"speed":7.66,"deg":85.5031},"rain":{},"sys":{"pod":"d"},"dt_txt":"2018-12-30 12:00:00"},{"dt":1546182000,"main":{"temp":291.399,"temp_min":291.399,"temp_max":291.399,"pressure":1033.01,"sea_level":1036.29,"grnd_level":1033.01,"humidity":100,"temp_kf":0},"weather":[{"id":800,"main":"Clear","description":"clear sky","icon":"01d"}],"clouds":{"all":0},"wind":{"speed":6.82,"deg":87.0024},"rain":{},"sys":{"pod":"d"},"dt_txt":"2018-12-30 15:00:00"}],"city":{"id":2593105,"name":"Região Autónoma da Madeira","coord":{"lat":32.6667,"lon":-16.75},"country":"PT"}}';           
            $data = json_decode($body);
            $elements = Element::distinct()->get(['label']);
             return view('users.events',compact('myEvents','enum','data','elements'));
        }else{
            return redirect('/');
        }
    }

    public function eventManagement($id)
    {
        $event = Event::find($id);
       
        $table = 'elements';
            $columns = DB::select("SHOW COLUMNS FROM ". $table." WHERE Field = 'type'");
            preg_match("/^enum\(\'(.*)\'\)$/", $columns[0]->Type, $matches);
            $enum = explode("','", $matches[1]); //in $enum are all input types for an element
        $subscriptions = $event->users()->get();
        if($event->opening_subscription_date < Carbon::now())
        {
            $canEditEvent = false;
        }else{
            $canEditEvent = true;
        }
        $elements = Element::distinct()->get(['label']);
        return view('users.eventManagement',compact('event','subscriptions', 'enum','canEditEvent','elements'));
    }

}
